@echo off
title Instalador Inteligente - YouTube Ultra HD Video Downloader
color 0B

echo.
echo ========================================
echo    üöÄ INSTALADOR INTELIGENTE
echo    YouTube Ultra HD Video Downloader
echo ========================================
echo.
echo ‚ö° Este instalador detecta y repara Python autom√°ticamente
echo    y luego instala todo el programa desde GitHub
echo.

REM ========================================
REM    üîç DETECCI√ìN Y REPARACI√ìN DE PYTHON
REM ========================================

echo üîç Verificando Python...
echo.

set PYTHON_CMD=
set PYTHON_VERSION=
set PYTHON_PATH=
set PYTHON_NEEDS_REPAIR=0

REM Probar diferentes comandos de Python
python --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=python
    for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
    goto :python_working
)

python3 --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=python3
    for /f "tokens=2" %%i in ('python3 --version 2^>^&1') do set PYTHON_VERSION=%%i
    goto :python_working
)

py --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=py
    for /f "tokens=2" %%i in ('py --version 2^>^&1') do set PYTHON_VERSION=%%i
    goto :python_working
)

python.exe --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=python.exe
    for /f "tokens=2" %%i in ('python.exe --version 2^>^&1') do set PYTHON_VERSION=%%i
    goto :python_working
)

REM Python no est√° en PATH, buscar instalado
echo ‚ùå Python no est√° en PATH
echo üîç Buscando Python instalado en el sistema...
echo.

set PYTHON_NEEDS_REPAIR=1

REM Buscar en ubicaciones comunes
if exist "C:\Program Files\Python*" (
    for /d %%i in ("C:\Program Files\Python*") do (
        if exist "%%i\python.exe" (
            set PYTHON_PATH=%%i
            echo ‚úÖ Python encontrado en: %%i
            goto :found_installed_python
        )
    )
)

if exist "C:\Program Files (x86)\Python*" (
    for /d %%i in ("C:\Program Files (x86)\Python*") do (
        if exist "%%i\python.exe" (
            set PYTHON_PATH=%%i
            echo ‚úÖ Python encontrado en: %%i
            goto :found_installed_python
        )
    )
)

if exist "%LOCALAPPDATA%\Programs\Python*" (
    for /d %%i in ("%LOCALAPPDATA%\Programs\Python*") do (
        if exist "%%i\python.exe" (
            set PYTHON_PATH=%%i
            echo ‚úÖ Python encontrado en: %%i
            goto :found_installed_python
        )
    )
)

if exist "%USERPROFILE%\AppData\Local\Programs\Python*" (
    for /d %%i in ("%USERPROFILE%\AppData\Local\Programs\Python*") do (
        if exist "%%i\python.exe" (
            set PYTHON_PATH=%%i
            echo ‚úÖ Python encontrado en: %%i
            goto :found_installed_python
        )
    )
)

if exist "%USERPROFILE%\Python*" (
    for /d %%i in ("%USERPROFILE%\Python*") do (
        if exist "%%i\python.exe" (
            set PYTHON_PATH=%%i
            echo ‚úÖ Python encontrado en: %%i
            goto :found_installed_python
        )
    )
)

REM --- NUEVO BLOQUE: Instalaci√≥n autom√°tica de Python si no est√° ---
:python_not_found

echo ‚ùå No se encontr√≥ Python instalado

echo.
echo üì• Descargando instalador oficial de Python...
set PYTHON_VERSION_URL=https://www.python.org/ftp/python/3.11.8/python-3.11.8-amd64.exe
set PYTHON_INSTALLER=python-installer.exe

REM Descargar el instalador de Python
powershell -Command "Invoke-WebRequest -Uri '%PYTHON_VERSION_URL%' -OutFile '%PYTHON_INSTALLER%'"
if not exist "%PYTHON_INSTALLER%" (
    echo ‚ùå No se pudo descargar el instalador de Python
    echo.
    echo Descarga manual: %PYTHON_VERSION_URL%
    pause
    exit /b 1
)

echo ‚úÖ Instalador descargado: %PYTHON_INSTALLER%
echo.
echo üöÄ Instalando Python en modo PASIVO (ver√°s una barra de progreso)...
echo    Por favor, espera a que termine la instalaci√≥n.
echo    Si ves alg√∫n error, toma nota o haz captura de pantalla.
"%PYTHON_INSTALLER%" /passive InstallAllUsers=1 PrependPath=1 Include_pip=1
if errorlevel 1 (
    echo ‚ùå Error instalando Python
    pause
    exit /b 1
)

echo ‚úÖ Python instalado correctamente.
echo.
del "%PYTHON_INSTALLER%"
echo üîÑ Reiniciando detecci√≥n de Python...
goto :REINICIAR_DETECCION_PYTHON

REM --- FIN BLOQUE NUEVO ---

REM Justo antes de la detecci√≥n de Python, agregar etiqueta para reinicio
:REINICIAR_DETECCION_PYTHON
REM Re-detecci√≥n autom√°tica de Python tras la instalaci√≥n
set PYTHON_CMD=
set PYTHON_VERSION=
set PYTHON_PATH=

REM Intentar con 'python'
python --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=python
    for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
    for /f "usebackq tokens=*" %%p in (`python -c "import sys,os;print(os.path.dirname(sys.executable))"`) do set PYTHON_PATH=%%p
    goto :found_installed_python
)

REM Intentar con 'python3'
python3 --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=python3
    for /f "tokens=2" %%i in ('python3 --version 2^>^&1') do set PYTHON_VERSION=%%i
    for /f "usebackq tokens=*" %%p in (`python3 -c "import sys,os;print(os.path.dirname(sys.executable))"`) do set PYTHON_PATH=%%p
    goto :found_installed_python
)

REM Intentar con 'py'
py --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=py
    for /f "tokens=2" %%i in ('py --version 2^>^&1') do set PYTHON_VERSION=%%i
    for /f "usebackq tokens=*" %%p in (`py -c "import sys,os;print(os.path.dirname(sys.executable))"`) do set PYTHON_PATH=%%p
    goto :found_installed_python
)

REM Intentar con 'python.exe'
python.exe --version >nul 2>&1
if not errorlevel 1 (
    set PYTHON_CMD=python.exe
    for /f "tokens=2" %%i in ('python.exe --version 2^>^&1') do set PYTHON_VERSION=%%i
    for /f "usebackq tokens=*" %%p in (`python.exe -c "import sys,os;print(os.path.dirname(sys.executable))"`) do set PYTHON_PATH=%%p
    goto :found_installed_python
)

REM Si a√∫n no se detecta, volver al flujo de instalaci√≥n
goto :python_not_found

:found_installed_python
echo.
echo üìã Informaci√≥n de Python:
echo - Ruta: %PYTHON_PATH%
echo - Ejecutable: %PYTHON_PATH%\python.exe
echo.

REM Verificar versi√≥n
echo üîç Verificando versi√≥n...
"%PYTHON_PATH%\python.exe" --version >nul 2>&1
if not errorlevel 1 (
    for /f "tokens=2" %%i in ('"%PYTHON_PATH%\python.exe" --version 2^>^&1') do set PYTHON_VERSION=%%i
    echo ‚úÖ Versi√≥n: %PYTHON_VERSION%
) else (
    echo ‚ùå No se pudo obtener la versi√≥n
    set PYTHON_VERSION=Desconocida
)

REM Verificar versi√≥n m√≠nima
for /f "tokens=2 delims=." %%a in ("%PYTHON_VERSION%") do set MAJOR_VERSION=%%a
for /f "tokens=3 delims=." %%b in ("%PYTHON_VERSION%") do set MINOR_VERSION=%%b

if %MAJOR_VERSION% LSS 3 (
    echo ‚ùå Python %PYTHON_VERSION% no es compatible
    echo üìã Se requiere Python 3.8 o superior
    goto :python_not_found
)

if %MAJOR_VERSION% EQU 3 (
    if %MINOR_VERSION% LSS 8 (
        echo ‚ùå Python %PYTHON_VERSION% no es compatible
        echo üìã Se requiere Python 3.8 o superior
        goto :python_not_found
    )
)

echo ‚úÖ Versi√≥n compatible: %PYTHON_VERSION%
echo.

REM Reparar Python si es necesario
if %PYTHON_NEEDS_REPAIR% EQU 1 (
    echo üîß Python necesita ser agregado al PATH
    echo.
    echo ‚ö†Ô∏è  IMPORTANTE: Este script necesita permisos de administrador
    echo para modificar las variables de entorno del sistema.
    echo.
    echo üîí Verificando permisos de administrador...
    net session >nul 2>&1
    if errorlevel 1 (
        echo ‚ùå No tienes permisos de administrador
        echo.
        echo üîß Soluciones:
        echo 1. Hacer clic derecho en este archivo
        echo 2. Seleccionar "Ejecutar como administrador"
        echo 3. O ejecutar CMD como administrador y navegar aqu√≠
        echo.
        pause
        exit /b 1
    )

    echo ‚úÖ Permisos de administrador confirmados
    echo.

    echo üîß Agregando Python al PATH del sistema...
    echo.

    REM Agregar Python al PATH del sistema
    setx PATH "%PATH%;%PYTHON_PATH%" /M
    if errorlevel 1 (
        echo ‚ùå Error agregando Python al PATH del sistema
        echo.
        echo üîß Intentando m√©todo alternativo...
        echo.
        
        REM M√©todo alternativo: modificar PATH del usuario
        echo üîß Agregando Python al PATH del usuario...
        setx PATH "%PATH%;%PYTHON_PATH%"
        if errorlevel 1 (
            echo ‚ùå Error agregando Python al PATH del usuario
            echo.
            echo üîß M√©todo manual requerido:
            echo 1. Presiona Win + R
            echo 2. Escribe: sysdm.cpl
            echo 3. Ve a: Avanzado -^> Variables de entorno
            echo 4. En "Variables del sistema", busca "Path"
            echo 5. Agrega: %PYTHON_PATH%
            echo.
            pause
            exit /b 1
        ) else (
            echo ‚úÖ Python agregado al PATH del usuario
        )
    ) else (
        echo ‚úÖ Python agregado al PATH del sistema
    )

    echo.
    echo üîß Agregando Scripts al PATH...
    if exist "%PYTHON_PATH%\Scripts" (
        setx PATH "%PATH%;%PYTHON_PATH%\Scripts" /M
        if not errorlevel 1 (
            echo ‚úÖ Scripts de Python agregados al PATH
        ) else (
            echo ‚ö†Ô∏è  No se pudieron agregar los Scripts al PATH
        )
    )

    echo.
    echo üîÑ Reiniciando variables de entorno...
    call refreshenv >nul 2>&1

    echo.
    echo üß™ Probando Python desde PATH...
    echo.

    REM Probar Python
    python --version >nul 2>&1
    if not errorlevel 1 (
        set PYTHON_CMD=python
        echo ‚úÖ Python funciona correctamente desde PATH
    ) else (
        echo ‚ùå Python a√∫n no funciona desde PATH
        echo.
        echo üîß Soluci√≥n manual requerida:
        echo 1. Reinicia la consola/terminal
        echo 2. O reinicia el explorador de Windows
        echo 3. O reinicia la computadora
        echo.
        echo üìã Ruta de Python: %PYTHON_PATH%
        echo.
        pause
        exit /b 1
    )
)

:python_working
echo.
echo üéâ ¬°Python est√° funcionando correctamente!
echo üìã Comando: %PYTHON_CMD%
echo üìã Versi√≥n: %PYTHON_VERSION%
echo.

REM ========================================
REM    üì• INSTALACI√ìN DEL PROGRAMA
REM ========================================

echo üì• Descargando proyecto completo desde GitHub...
echo.

REM Crear directorio de trabajo
if not exist "YouTubeUltraHD" mkdir YouTubeUltraHD
cd YouTubeUltraHD

REM Descargar ZIP del repositorio
echo üîÑ Descargando archivos...
powershell -Command "try { Invoke-WebRequest -Uri 'https://github.com/Kasaco223/K-YoutubeVideoDownloaderHD/archive/refs/heads/master.zip' -OutFile 'project.zip' -UseBasicParsing; Write-Host '‚úÖ Descarga completada' } catch { Write-Host '‚ùå Error en descarga: ' $_.Exception.Message }"

if not exist "project.zip" (
    echo.
    echo ‚ùå Error descargando autom√°ticamente
    echo.
    echo üîß Descarga manual:
    echo 1. Ve a: https://github.com/Kasaco223/K-YoutubeVideoDownloaderHD
    echo 2. Haz clic en "Code" -^> "Download ZIP"
    echo 3. Guarda el ZIP en esta carpeta
    echo 4. Ren√≥mbralo a: project.zip
    echo 5. Presiona cualquier tecla para continuar
    echo.
    pause
)

echo.
echo üì¶ Extrayendo archivos...
powershell -Command "try { Expand-Archive -Path 'project.zip' -DestinationPath '.' -Force; Write-Host '‚úÖ Extracci√≥n completada' } catch { Write-Host '‚ùå Error en extracci√≥n: ' $_.Exception.Message }"

REM Buscar carpeta extra√≠da
for /d %%i in (K-YoutubeVideoDownloaderHD-*) do (
    echo ‚úÖ Archivos extra√≠dos en: %%i
    cd "%%i"
    goto :continue
)

:continue

echo.
echo üîÅ Sincronizando archivo local actualizado (si existe)...
REM Copiar el .py local del instalador dentro del repo extra√≠do antes de compilar
set LOCAL_DIR=%~dp0
if exist "%LOCAL_DIR%youtube_360_downloader.py" (
    copy "%LOCAL_DIR%youtube_360_downloader.py" "youtube_360_downloader.py" /Y >nul
    echo ‚úÖ Archivo youtube_360_downloader.py actualizado desde el instalador
) else (
    echo ‚ÑπÔ∏è No se encontr√≥ una versi√≥n local para sobrescribir; se usar√° la del repositorio
)

echo.
echo üì¶ Instalando/actualizando dependencias...
echo üîß Usando: %PYTHON_CMD% -m pip install --upgrade -r requirements.txt
%PYTHON_CMD% -m pip install --upgrade -r requirements.txt
if errorlevel 1 (
    echo ‚ùå Error instalando dependencias
    echo üîß Intentando con --user...
    %PYTHON_CMD% -m pip install --user -r requirements.txt
    if errorlevel 1 (
        echo ‚ùå Error persistente con dependencias
        echo.
        echo üîç Diagn√≥stico:
        echo - Python: %PYTHON_CMD% %PYTHON_VERSION%
        echo - pip: %PYTHON_CMD% -m pip --version
        echo - Directorio actual: %CD%
        echo - Archivo requirements: %CD%\requirements.txt
        echo.
        pause
        exit /b 1
    )
)

echo ‚úÖ Dependencias instaladas/actualizadas
echo.
echo üîÑ Asegurando la √∫ltima yt-dlp (cambios recientes de YouTube)...
%PYTHON_CMD% -m pip install --upgrade yt-dlp
echo.

echo üîß Instalando PyInstaller...
%PYTHON_CMD% -m pip install pyinstaller
if errorlevel 1 (
    echo ‚ùå Error instalando PyInstaller
    echo üîß Intentando con --user...
    %PYTHON_CMD% -m pip install --user pyinstaller
    if errorlevel 1 (
        echo ‚ùå Error persistente con PyInstaller
        pause
        exit /b 1
    )
)

echo ‚úÖ PyInstaller instalado
echo.

echo üé® Creando icono...
%PYTHON_CMD% -c "from PIL import Image, ImageDraw; img = Image.new('RGBA', (256, 256), (0, 0, 0, 0)); draw = ImageDraw.Draw(img); draw.ellipse([20, 20, 236, 236], fill=(99, 102, 241, 255)); img.save('icon.ico', format='ICO', sizes=[(256, 256)])"
if errorlevel 1 (
    echo ‚ö†Ô∏è  No se pudo crear el icono (continuando...)
) else (
    echo ‚úÖ Icono creado
)

echo.
echo ‚öôÔ∏è  Creando ejecutable...
echo üî® Esto puede tomar varios minutos...
echo üîß Usando: %PYTHON_CMD% -m PyInstaller
echo.

%PYTHON_CMD% -m PyInstaller --onefile --windowed --name=YouTubeUltraHDDownloader --icon=icon.ico youtube_360_downloader.py

if errorlevel 1 (
    echo ‚ùå Error creando ejecutable
    echo üîß Continuando con versi√≥n Python...
    echo.
    echo ‚úÖ El programa funcionar√° con: %PYTHON_CMD% youtube_360_downloader.py
) else (
    echo ‚úÖ Ejecutable creado exitosamente!
)

echo.
echo üßπ Limpiando archivos temporales...
if exist build rmdir /s /q build
if exist *.spec del *.spec
if exist project.zip del project.zip

echo.
echo üìÅ Moviendo ejecutable al directorio del instalador...
cd ..

REM Directorio del instalador (misma ruta que este .bat)
set DEST_DIR=%~dp0

REM Copiar archivos importantes desde la carpeta extra√≠da
for /d %%i in (K-YoutubeVideoDownloaderHD-*) do (
    if exist "%%i\dist\YouTubeUltraHDDownloader.exe" copy "%%i\dist\YouTubeUltraHDDownloader.exe" "%DEST_DIR%" /Y
    if exist "%%i\youtube_360_downloader.py" copy "%%i\youtube_360_downloader.py" "%DEST_DIR%" /Y
    if exist "%%i\requirements.txt" copy "%%i\requirements.txt" "%DEST_DIR%" /Y
    if exist "%%i\README.md" copy "%%i\README.md" "%DEST_DIR%" /Y
)

REM ========================================
REM     üé¨ FFmpeg (para fusionar video+audio)
REM ========================================
echo.
echo üîé Comprobando FFmpeg...
set BIN_DIR=%DEST_DIR%bin
if not exist "%BIN_DIR%" mkdir "%BIN_DIR%"

set FF_EXE=%BIN_DIR%ffmpeg.exe
set FP_EXE=%BIN_DIR%ffprobe.exe

if exist "%FF_EXE%" (
    if exist "%FP_EXE%" (
        echo ‚úÖ FFmpeg ya est√° presente en: %BIN_DIR%
        goto :ffmpeg_done
    )
)

echo ‚öôÔ∏è  Intentando instalar FFmpeg con winget (si est√° disponible)...
where winget >nul 2>&1
if not errorlevel 1 (
    winget install --id FFmpeg.FFmpeg -e --source winget --accept-source-agreements --accept-package-agreements
)

REM Tras winget, si ffmpeg est√° en PATH, no necesitamos portable
where ffmpeg >nul 2>&1
if not errorlevel 1 (
    echo ‚úÖ FFmpeg instalado en el sistema (PATH). Se usar√° autom√°ticamente si es necesario.
    goto :ffmpeg_done
)

echo üì• Descargando FFmpeg portable (essentials)...
set FFMPEG_ZIP=ffmpeg-release-essentials.zip
powershell -Command "try { Invoke-WebRequest -Uri 'https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip' -OutFile '%FFMPEG_ZIP%' -UseBasicParsing; Write-Host '‚úÖ Descarga FFmpeg completada' } catch { Write-Host '‚ùå Error descargando FFmpeg: ' $_.Exception.Message }"

if exist "%FFMPEG_ZIP%" (
    echo üì¶ Extrayendo FFmpeg...
    rmdir /s /q ffmpeg_tmp >nul 2>&1
    mkdir ffmpeg_tmp
    powershell -Command "try { Expand-Archive -Path '%FFMPEG_ZIP%' -DestinationPath 'ffmpeg_tmp' -Force; Write-Host '‚úÖ Extracci√≥n FFmpeg completada' } catch { Write-Host '‚ùå Error extrayendo FFmpeg: ' $_.Exception.Message }"

    for /d %%j in (ffmpeg_tmp\ffmpeg-*) do (
        if exist "%%j\bin\ffmpeg.exe" copy "%%j\bin\ffmpeg.exe" "%FF_EXE%" /Y
        if exist "%%j\bin\ffprobe.exe" copy "%%j\bin\ffprobe.exe" "%FP_EXE%" /Y
    )

    if exist "%FF_EXE%" (
        echo ‚úÖ FFmpeg copiado a: %FF_EXE%
    ) else (
        echo ‚ö†Ô∏è  No se pudo ubicar ffmpeg.exe en el ZIP
    )

    if exist "%FP_EXE%" (
        echo ‚úÖ FFprobe copiado a: %FP_EXE%
    ) else (
        echo ‚ö†Ô∏è  No se pudo ubicar ffprobe.exe en el ZIP
    )

    del "%FFMPEG_ZIP%" >nul 2>&1
    rmdir /s /q ffmpeg_tmp >nul 2>&1
) else (
    echo ‚ùå No se pudo descargar FFmpeg portable.
)

:ffmpeg_done

echo.
echo üßπ Limpieza final...
rmdir /s /q K-YoutubeVideoDownloaderHD-*

echo.
echo üéâ ¬°PROGRAMA LISTO PARA USAR!
echo ========================================
echo.
echo üìÅ Ejecutable en: %DEST_DIR%YouTubeUltraHDDownloader.exe
echo.
if exist "%DEST_DIR%YouTubeUltraHDDownloader.exe" (
    echo ‚úÖ YouTubeUltraHDDownloader.exe (Ejecutable)
    echo üöÄ Doble clic para ejecutar desde esta misma carpeta
) else (
    echo ‚úÖ youtube_360_downloader.py (C√≥digo fuente)
    echo üöÄ Ejecuta: %PYTHON_CMD% youtube_360_downloader.py
)
echo.
echo üìñ README.md (Documentaci√≥n)
echo üìã requirements.txt (Dependencias)
echo.
echo üåê Repositorio: https://github.com/Kasaco223/K-YoutubeVideoDownloaderHD
echo.
echo ¬°Disfruta descargando videos en Ultra HD! üé¨‚ú®
echo.
pause
